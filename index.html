<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#dff1ff" />
  <title>라이브더센텀 주차위반 제보</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <style>
    :root{
      --card: rgba(255,255,255,.96);
      --text:#1f2937;
      --muted:#6b7280;
      --primary:#2563eb;
      --primarySoft:rgba(37,99,235,.12);
      --danger:#ef4444;
      --success:#16a34a;
      --radius:22px;
      --shadow:0 14px 34px rgba(15,23,42,.08);
      --shadow2:0 10px 22px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0}
    html,body{
      min-height:100%;
      font-family:"Noto Sans KR",-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
      color:var(--text);
      overflow-x:hidden;
      background:
        radial-gradient(120px 60px at 20% 18%, rgba(255,255,255,.75) 0%, transparent 70%),
        radial-gradient(160px 80px at 70% 22%, rgba(255,255,255,.65) 0%, transparent 70%),
        radial-gradient(220px 110px at 45% 32%, rgba(255,255,255,.55) 0%, transparent 70%),
        radial-gradient(180px 90px at 86% 38%, rgba(255,255,255,.50) 0%, transparent 70%),
        linear-gradient(180deg, #dff1ff 0%, #edf7ff 35%, #f7fbff 60%, #ffffff 100%);
    }
    .screen{
      position:relative;
      z-index:1;
      padding:18px 16px calc(118px + env(safe-area-inset-bottom));
      max-width:640px;
      margin:0 auto;
    }
    .header{ margin:14px 0 12px; }
    h1{ font-size:26px; font-weight:900; letter-spacing:-.6px; line-height:1.15; }
    .subtitle{ margin-top:6px; font-size:14px; color:var(--muted); font-weight:600; }

    .banner{
      border-radius:24px;
      padding:18px;
      margin:14px 0 18px;
      background:
        radial-gradient(420px 220px at 15% 40%, rgba(37,99,235,.14) 0%, transparent 60%),
        radial-gradient(420px 260px at 85% 60%, rgba(22,163,74,.10) 0%, transparent 62%),
        linear-gradient(135deg, #ffffff 0%, #f2f8ff 52%, #f2fff9 100%);
      border:1px solid rgba(255,255,255,.72);
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .banner-title{font-size:16px; font-weight:900; letter-spacing:-.3px;}
    .banner-desc{margin-top:6px; font-size:13px; color:var(--muted); font-weight:600;}

    .section{
      margin:18px 0 10px;
      font-size:15px;
      font-weight:900;
      letter-spacing:-.2px;
      color:#334155;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .section-icon{
      font-size:18px;
      width:26px;height:26px;
      display:inline-flex;
      align-items:center;justify-content:center;
      border-radius:10px;
      background:var(--primarySoft);
      color:var(--primary);
    }

    .card{
      background:var(--card);
      backdrop-filter: blur(10px);
      border-radius:22px;
      padding:18px;
      margin-bottom:12px;
      border:1px solid rgba(31,41,55,.06);
      box-shadow:var(--shadow2);
    }
    label{
      font-weight:900;
      font-size:15px;
      display:flex;
      align-items:center;
      gap:8px;
      letter-spacing:-.2px;
    }
    .hint{
      margin-top:8px;
      font-size:13px;
      color:var(--muted);
      font-weight:600;
      line-height:1.45;
    }

    input[type="text"], textarea{
      width:100%;
      margin-top:12px;
      padding:14px 14px;
      border-radius:16px;
      border:1.5px solid rgba(31,41,55,.10);
      background:rgba(255,255,255,.92);
      font-size:16px;
      color:var(--text);
      font-family:inherit;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    input[type="text"]:focus, textarea:focus{
      outline:none;
      border-color:rgba(37,99,235,.55);
      box-shadow:0 0 0 4px rgba(37,99,235,.14);
      background:#fff;
    }
    textarea{ min-height:110px; resize:vertical; }

    .btn{
      width:100%;
      margin-top:14px;
      padding:14px 14px;
      border-radius:16px;
      border:1.5px solid rgba(37,99,235,.28);
      background:rgba(255,255,255,.95);
      color:var(--primary);
      font-weight:900;
      font-size:15px;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .15s ease, background .15s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    .btn:active{ transform:scale(.98); }

    .photo-count{
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin-top:10px;
      padding:8px 12px;
      background:rgba(22,163,74,.10);
      border:1.5px solid rgba(22,163,74,.14);
      border-radius:999px;
      font-size:12px;
      color:#166534;
      font-weight:900;
    }

    .previews{
      display:flex;
      gap:10px;
      margin-top:14px;
      overflow-x:auto;
      padding-bottom:4px;
      -webkit-overflow-scrolling:touch;
    }
    .previews::-webkit-scrollbar{ display:none; }
    .thumb{
      width:104px;height:104px;
      border-radius:18px;
      overflow:hidden;
      position:relative;
      flex-shrink:0;
      border:2px solid rgba(37,99,235,.12);
      box-shadow:0 12px 24px rgba(15,23,42,.08);
      background:#fff;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; }
    .thumb button{
      position:absolute;
      top:8px; right:8px;
      width:32px; height:32px;
      border-radius:999px;
      border:none;
      background:rgba(239,68,68,.92);
      color:#fff;
      font-size:18px;
      cursor:pointer;
    }

    .checkbox-label{
      display:flex;
      align-items:flex-start;
      gap:10px;
      cursor:pointer;
      font-weight:900;
      line-height:1.4;
    }
    input[type="checkbox"]{
      width:20px;height:20px;
      accent-color:var(--primary);
      margin-top:2px;
    }

    .bottom{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 14px calc(10px + env(safe-area-inset-bottom));
      background:rgba(255,255,255,.88);
      backdrop-filter: blur(16px);
      border-top:1px solid rgba(31,41,55,.08);
      z-index:100;
    }
    .bottom-content{ max-width:640px; margin:0 auto; }

    .submit{
      width:100%;
      padding:16px 16px;
      border-radius:18px;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 55%, #60a5fa 100%);
      color:#fff;
      font-size:16px;
      font-weight:900;
      border:none;
      cursor:pointer;
      box-shadow:0 16px 30px rgba(37,99,235,.20);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .submit:disabled{
      opacity:.45;
      background:#cbd5e1;
      box-shadow:none;
      cursor:not-allowed;
    }

    .toast{
      margin-top:10px;
      padding:12px 14px;
      border-radius:16px;
      font-size:14px;
      font-weight:900;
      text-align:center;
      background:rgba(22,163,74,.10);
      border:1.5px solid rgba(22,163,74,.16);
      color:#166534;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .toast.error{
      background:rgba(239,68,68,.10);
      border-color:rgba(239,68,68,.16);
      color:#991b1b;
    }

    .spinner{
      width:18px;height:18px;
      border:2px solid rgba(255,255,255,.35);
      border-top-color:#fff;
      border-radius:50%;
      animation: spin .7s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg);} }
  </style>
</head>

<body>
  <div id="root"></div>

  <script>
    // 1) 여기만 너 Worker 주소로 정확히 넣으면 됨
    const API_URL = "https://dawn-frost-9b1a.wlalsqqq.workers.dev/api/report";

    const {useState, useRef, useMemo, useEffect} = React;

    function App() {
      const fileRef = useRef();

      const [location, setLocation] = useState("");
      const [plate, setPlate] = useState("");
      const [phone, setPhone] = useState(""); // 선택
      const [note, setNote] = useState("");
      const [files, setFiles] = useState([]);
      const [agree, setAgree] = useState(false);

      const [loading, setLoading] = useState(false);
      const [toast, setToast] = useState("");
      const [toastType, setToastType] = useState("success");

      const [previewUrls, setPreviewUrls] = useState([]);
      useEffect(() => {
        const urls = files.map(f => URL.createObjectURL(f));
        setPreviewUrls(urls);
        return () => urls.forEach(u => URL.revokeObjectURL(u));
      }, [files]);

      const canSubmit = useMemo(
        () => location.trim() && plate.trim() && files.length > 0 && agree && !loading,
        [location, plate, files, agree, loading]
      );

      function onFiles(e) {
        const picked = Array.from(e.target.files || []);
        if (!picked.length) return;

        setFiles(prev => {
          const map = new Map(prev.map(f => [f.name+"_"+f.size+"_"+f.lastModified, f]));
          for (const f of picked) map.set(f.name+"_"+f.size+"_"+f.lastModified, f);
          return Array.from(map.values());
        });

        e.target.value = "";
      }

      function remove(idx) {
        setFiles(f => f.filter((_, i) => i !== idx));
      }

      // 이미지 압축: 최대 1280px, jpeg 0.82
      async function fileToCompressedDataUrl(file, maxW = 1280, quality = 0.82) {
        const img = await new Promise((resolve, reject) => {
          const i = new Image();
          i.onload = () => resolve(i);
          i.onerror = reject;
          i.src = URL.createObjectURL(file);
        });

        const w0 = img.naturalWidth || img.width;
        const h0 = img.naturalHeight || img.height;

        const scale = Math.min(1, maxW / w0);
        const w = Math.round(w0 * scale);
        const h = Math.round(h0 * scale);

        const canvas = document.createElement("canvas");
        canvas.width = w;
        canvas.height = h;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, w, h);

        try { URL.revokeObjectURL(img.src); } catch {}

        return canvas.toDataURL("image/jpeg", quality);
      }

      async function submit() {
        setToast("");
        setLoading(true);

        try {
          // 압축된 base64 생성
          const images = [];
          for (const f of files) {
            images.push(await fileToCompressedDataUrl(f));
          }

          const payload = {
            location: location.trim(),
            plate: plate.trim(),
            phone: phone.trim(),
            note: note.trim(),
            images,
            ip: "-" // 필요하면 Worker에서 붙이도록 바꿔도 됨
          };

          const res = await fetch(API_URL, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload) // action/data 없이 "순수 데이터"만 보냄
          });

          const text = await res.text().catch(() => "");

          // Worker는 디버그용으로 {ok, gasStatus, gasBody}를 주게 만들 예정
          // JSON이 아니어도 원문을 보여줘서 원인 추적 가능
          let parsed = null;
          try { parsed = JSON.parse(text); } catch {}

          if (!res.ok) {
            throw new Error(text || ("HTTP " + res.status));
          }

          // Worker 디버그 응답 기준
          if (parsed && parsed.ok === false) {
            throw new Error("GAS 실패\n" + JSON.stringify(parsed, null, 2));
          }

          setToastType("success");
          setToast("접수가 완료되었습니다.");

          setLocation("");
          setPlate("");
          setPhone("");
          setNote("");
          setFiles([]);
          setAgree(false);

          setTimeout(() => setToast(""), 3500);
        } catch (e) {
          setToastType("error");
          setToast("제출 실패\n" + String(e && e.message ? e.message : e));
        } finally {
          setLoading(false);
        }
      }

      return React.createElement("div", {className: "screen"},
        React.createElement("div", {className: "header"},
          React.createElement("h1", null, "라이브더센텀 주차위반 제보"),
          React.createElement("div", {className: "subtitle"}, "위반 사실이 명확히 보이도록 사진을 첨부해 주세요.")
        ),

        React.createElement("div", {className: "banner"},
          React.createElement("div", {className: "banner-title"}, "불법 주차 및 위반 사항 제보"),
          React.createElement("div", {className: "banner-desc"}, "번호판과 주차 위치가 함께 보이게 촬영해 주세요.")
        ),

        React.createElement("div", {className: "section"},
          React.createElement("span", {className: "section-icon"}, "1"),
          "신고 내용"
        ),

        React.createElement("div", {className: "card"},
          React.createElement("label", null, "위치"),
          React.createElement("div", {className: "hint"}, "동·층·구역을 구체적으로 입력해 주세요."),
          React.createElement("input", {
            type: "text",
            value: location,
            onChange: e => setLocation(e.target.value),
            placeholder: "예: 101동 B2층 A구역"
          })
        ),

        React.createElement("div", {className: "card"},
          React.createElement("label", null, "차량번호"),
          React.createElement("div", {className: "hint"}, "차량번호를 입력해 주세요."),
          React.createElement("input", {
            type: "text",
            value: plate,
            onChange: e => setPlate(e.target.value),
            placeholder: "예: 12가3456",
            autoCapitalize: "characters"
          })
        ),

        React.createElement("div", {className: "card"},
          React.createElement("label", null, "연락처 (선택)"),
          React.createElement("div", {className: "hint"}, "필요 시 확인 연락용(선택)."),
          React.createElement("input", {
            type: "text",
            value: phone,
            onChange: e => setPhone(e.target.value),
            placeholder: "예: 010-1234-5678"
          })
        ),

        React.createElement("div", {className: "card"},
          React.createElement("label", null, "사진"),
          React.createElement("div", {className: "hint"}, "사진은 자동 압축되어 전송됩니다."),
          files.length > 0 && React.createElement("div", {className: "photo-count"},
            `사진 ${files.length}장 첨부됨`
          ),

          React.createElement("button", {
            className: "btn",
            type: "button",
            onClick: () => fileRef.current && fileRef.current.click()
          }, "사진 촬영/추가"),

          React.createElement("input", {
            ref: fileRef,
            type: "file",
            accept: "image/*",
            multiple: true,
            capture: "environment",
            onChange: onFiles,
            style: {display: "none"}
          }),

          previewUrls.length > 0 && React.createElement("div", {className: "previews"},
            previewUrls.map((url, i) =>
              React.createElement("div", {className: "thumb", key: i},
                React.createElement("img", {src: url, alt: "preview"}),
                React.createElement("button", {type:"button", onClick: () => remove(i)}, "×")
              )
            )
          )
        ),

        React.createElement("div", {className: "section"},
          React.createElement("span", {className: "section-icon"}, "2"),
          "추가 정보"
        ),

        React.createElement("div", {className: "card"},
          React.createElement("label", null, "비고 (선택)"),
          React.createElement("div", {className: "hint"}, "상습/반복 여부, 특이사항이 있으면 남겨 주세요."),
          React.createElement("textarea", {
            value: note,
            onChange: e => setNote(e.target.value),
            placeholder: "예: 3일 연속 같은 자리 주차, 통행 방해 등"
          })
        ),

        React.createElement("div", {className: "card"},
          React.createElement("label", {className: "checkbox-label"},
            React.createElement("input", {
              type: "checkbox",
              checked: agree,
              onChange: e => setAgree(e.target.checked)
            }),
            "증거 제공 및 처리에 동의합니다"
          ),
          React.createElement("div", {className: "hint", style: {marginTop: "10px"}},
            `위치: ${location ? '입력됨' : '미입력'} | 차량번호: ${plate ? '입력됨' : '미입력'} | 사진: ${files.length}장 | 동의: ${agree ? '완료' : '필요'}`
          )
        ),

        React.createElement("div", {className: "bottom"},
          React.createElement("div", {className: "bottom-content"},
            React.createElement("button", {
              className: "submit",
              disabled: !canSubmit,
              onClick: submit
            },
              loading && React.createElement("div", {className: "spinner"}),
              loading ? "제출 중..." : "제보 제출"
            ),
            toast && React.createElement(
              "div",
              { className: `toast ${toastType === 'error' ? 'error' : ''}` },
              toast
            )
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
  </script>
</body>
</html>
