<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>ë¼ì´ë¸Œë”ì„¼í…€ ì£¼ì°¨ìœ„ë°˜ ì œë³´</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<style>
/* ================= ê¸°ë³¸ ================= */
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:"Noto Sans KR",system-ui,sans-serif;
  background:#f1f5f9;
  color:#1f2937;
}
.screen{max-width:640px;margin:0 auto;padding:18px 16px 120px}

/* ================= ì¹´ë“œ ================= */
.card{
  background:#fff;
  border-radius:18px;
  padding:16px;
  margin-bottom:14px;
  box-shadow:0 10px 24px rgba(15,23,42,.08)
}
label{font-weight:900;font-size:15px}
.hint{font-size:13px;color:#64748b;margin-top:6px}
.hint.multiline{white-space:pre-line}

input,textarea{
  width:100%;
  margin-top:10px;
  padding:14px;
  font-size:16px;
  border-radius:14px;
  border:1.5px solid #e5e7eb;
}
textarea{min-height:110px}

/* ================= ë²„íŠ¼ ================= */
button{
  width:100%;
  padding:16px;
  border-radius:16px;
  border:none;
  font-weight:900;
  background:linear-gradient(135deg,#2563eb,#3b82f6);
  color:#fff;
}
button:disabled{opacity:.4}

/* ================= ì‚¬ì§„ ================= */
.previews{display:flex;gap:10px;margin-top:12px;overflow-x:auto}
.thumb{width:100px;height:100px;border-radius:14px;overflow:hidden;position:relative}
.thumb img{width:100%;height:100%;object-fit:cover}
.thumb button{
  position:absolute;top:6px;right:6px;
  width:28px;height:28px;border-radius:50%;
  background:#ef4444;color:#fff;border:none;
}

/* ================= í•˜ë‹¨ ================= */
.bottom{
  position:fixed;left:0;right:0;bottom:0;
  padding:12px;background:#fff;border-top:1px solid #e5e7eb
}

/* ================= ëª¨ë‹¬ + ë¡œë”©ë°” ================= */
.modal-backdrop{
  position:fixed;inset:0;background:rgba(15,23,42,.4);
  display:flex;align-items:center;justify-content:center;z-index:9999
}
.modal{
  width:90%;max-width:420px;background:#fff;
  border-radius:20px;padding:18px
}
.progress-wrap{
  width:100%;height:10px;background:#e5e7eb;
  border-radius:999px;margin-top:14px;overflow:hidden
}
.progress-bar{
  height:100%;
  background:linear-gradient(90deg,#60a5fa,#2563eb,#60a5fa);
  background-size:200% 100%;
  animation:move 1.2s linear infinite
}
@keyframes move{from{background-position:0%}to{background-position:200%}}

/* ================= PC ì°¨ë‹¨ ================= */
.pc-wrap{
  min-height:100vh;display:flex;align-items:center;justify-content:center
}
.pc-card{
  background:#fff;padding:28px;border-radius:20px;
  text-align:center;max-width:420px
}
.pc-toast{
  position:fixed;top:16px;left:50%;
  transform:translateX(-50%);
  background:#111827;color:#fff;
  padding:12px 16px;border-radius:12px;
  font-weight:900;z-index:10000;
  white-space:pre-line
}
</style>
</head>

<body>
<div id="root"></div>

<script>
const API_URL = "https://dawn-frost-9b1a.wlalsqqq.workers.dev/api/report";
const MAX_PHOTOS = 5;
const MAX_WIDTH = 1024;
const JPEG_QUALITY = 0.72;

const {useState,useRef,useEffect,useMemo} = React;

function isMobile(){
  const ua = navigator.userAgent.toLowerCase();
  const hasTouch = navigator.maxTouchPoints > 0;
  return hasTouch && (ua.includes("android")||ua.includes("iphone")||ua.includes("ipad"));
}

function App(){
  const fileRef = useRef();

  const [isMobileOk,setIsMobileOk] = useState(true);
  const [showPcMsg,setShowPcMsg] = useState(true);

  const [location,setLocation] = useState("");
  const [plate,setPlate] = useState("");
  const [phone,setPhone] = useState("");
  const [note,setNote] = useState("");
  const [files,setFiles] = useState([]);
  const [agree,setAgree] = useState(false);

  const [loading,setLoading] = useState(false);
  const [progress,setProgress] = useState(0);

  const [previews,setPreviews] = useState([]);

  useEffect(()=>{
    setIsMobileOk(isMobile());
  },[]);

  useEffect(()=>{
    if(!isMobileOk){
      const t=setTimeout(()=>setShowPcMsg(false),3000);
      return ()=>clearTimeout(t);
    }
  },[isMobileOk]);

  useEffect(()=>{
    const urls = files.map(f=>URL.createObjectURL(f));
    setPreviews(urls);
    return ()=>urls.forEach(u=>URL.revokeObjectURL(u));
  },[files]);

  if(!isMobileOk){
    return React.createElement(React.Fragment,null,
      showPcMsg && React.createElement("div",{className:"pc-toast"},
        "âš ï¸ ëª¨ë°”ì¼ ì „ìš© ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤\nPCì—ì„œëŠ” ì ‘ìˆ˜ê°€ ì œí•œë©ë‹ˆë‹¤"
      ),
      React.createElement("div",{className:"pc-wrap"},
        React.createElement("div",{className:"pc-card"},
          React.createElement("div",{style:{fontSize:"42px"}}, "ğŸ“±"),
          React.createElement("h2",null,"ëª¨ë°”ì¼ ì „ìš© í˜ì´ì§€"),
          React.createElement("p",{className:"hint"},
            "ì£¼ì°¨ìœ„ë°˜ ì œë³´ëŠ” íœ´ëŒ€í°ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
          )
        )
      )
    );
  }

  function normalizePlate(v){
    return v.replace(/\s+/g,"").toUpperCase();
  }
  function formatPhone(v){
    const d=v.replace(/\D/g,"");
    if(d.length<=3) return d;
    if(d.length<=7) return d.replace(/(\d{3})(\d+)/,"$1-$2");
    return d.replace(/(\d{3})(\d{4})(\d+)/,"$1-$2-$3");
  }

  async function compress(file){
    const img = await new Promise(res=>{
      const i=new Image();
      i.onload=()=>res(i);
      i.src=URL.createObjectURL(file);
    });
    const scale=Math.min(1,MAX_WIDTH/img.width);
    const c=document.createElement("canvas");
    c.width=img.width*scale;
    c.height=img.height*scale;
    c.getContext("2d").drawImage(img,0,0,c.width,c.height);
    return c.toDataURL("image/jpeg",JPEG_QUALITY);
  }

  async function submit(){
    setLoading(true);
    setProgress(20);

    try{
      const images = await Promise.all(files.map(f=>compress(f)));
      setProgress(60);

      await fetch(API_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          location,plate:normalizePlate(plate),
          phone:phone.replace(/\D/g,""),
          note,images,ip:"-"
        })
      });

      setProgress(100);
      alert("ì ‘ìˆ˜ ì™„ë£Œ");

      setLocation("");setPlate("");setPhone("");
      setNote("");setFiles([]);setAgree(false);
    }catch(e){
      alert("ì œì¶œ ì‹¤íŒ¨");
    }finally{
      setTimeout(()=>{
        setLoading(false);
        setProgress(0);
      },400);
    }
  }

  return React.createElement("div",{className:"screen"},
    React.createElement("h1",null,"ğŸš« ì£¼ì°¨ìœ„ë°˜ ì œë³´"),

    React.createElement("div",{className:"card"},
      React.createElement("label",null,"ìœ„ì¹˜"),
      React.createElement("input",{value:location,onChange:e=>setLocation(e.target.value)})
    ),

    React.createElement("div",{className:"card"},
      React.createElement("label",null,"ì°¨ëŸ‰ë²ˆí˜¸"),
      React.createElement("input",{value:plate,onChange:e=>setPlate(normalizePlate(e.target.value))})
    ),

    React.createElement("div",{className:"card"},
      React.createElement("label",null,"ì—°ë½ì²˜"),
      React.createElement("input",{value:phone,onChange:e=>setPhone(formatPhone(e.target.value))})
    ),

    React.createElement("div",{className:"card"},
      React.createElement("label",null,"ì‚¬ì§„"),
      React.createElement("div",{className:"hint multiline"},
        `ìë™ ì••ì¶• ì „ì†¡\nìµœëŒ€ ${MAX_PHOTOS}ì¥`
      ),
      React.createElement("button",{onClick:()=>fileRef.current.click()},"ì‚¬ì§„ ì¶”ê°€"),
      React.createElement("input",{type:"file",multiple:true,ref:fileRef,
        style:{display:"none"},
        onChange:e=>setFiles([...e.target.files].slice(0,MAX_PHOTOS))
      }),
      React.createElement("div",{className:"previews"},
        previews.map((u,i)=>
          React.createElement("div",{className:"thumb",key:i},
            React.createElement("img",{src:u}),
            React.createElement("button",{onClick:()=>setFiles(f=>f.filter((_,x)=>x!==i))},"Ã—")
          )
        )
      )
    ),

    React.createElement("div",{className:"card"},
      React.createElement("label",null,
        React.createElement("input",{type:"checkbox",checked:agree,onChange:e=>setAgree(e.target.checked)}),
        " ì¦ê±° ì œê³µì— ë™ì˜í•©ë‹ˆë‹¤"
      )
    ),

    React.createElement("div",{className:"bottom"},
      React.createElement("button",{disabled:!agree||files.length===0,onClick:submit},
        "ì œë³´ ì œì¶œ"
      )
    ),

    loading && React.createElement("div",{className:"modal-backdrop"},
      React.createElement("div",{className:"modal"},
        React.createElement("strong",null,"ì œë³´ ì ‘ìˆ˜ ì¤‘"),
        React.createElement("div",{className:"progress-wrap"},
          React.createElement("div",{className:"progress-bar",style:{width:progress+"%"}})
        )
      )
    )
  );
}

ReactDOM.createRoot(document.getElementById("root"))
  .render(React.createElement(App));
</script>
</body>
</html>
